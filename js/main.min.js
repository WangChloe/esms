$(document).ready(function(){var str=document.cookie;if(str){var arr=str.split('=');loginVerify.LoginSuccess(arr[0],arr[1])}$('.carousel').carousel({interval:3000});$('nav').on('mouseover','.userId',function(event){event.preventDefault();$(this).addClass('over');$(this).find('ul').show()}).on('mouseover','.userId ul',function(event){event.preventDefault();if(!$(this).parent().hasClass('over')){$(this).parent().addClass('over')}}).on('mouseout','.userId ul',function(event){event.preventDefault();$(this).parent().removeClass('over');$(this).hide()});listVerify.list();$('.login').on("click",function(e){e.preventDefault();$('#mask').show();$('.log').show(100);$('.reg, .est').hide()});$('.register').on("click",function(e){e.preventDefault();$('#mask').show();$('.reg').show(100);$('.log, .est').hide()});$('.establish').on("click",function(e){e.preventDefault();$('#mask').show();$('.est').show(100);$('.log, .reg').hide();var userId=$('.userId').attr('id').substring(4);$('#orderBase-Cid').val(userId)});$('.mod-login').click(function(){loginVerify.login()});$('.mod-register').click(function(){registerVerify.register()});$('.mod-est').click(function(){estVerify.est()})$('.listings').on('click','.status-btn',function(event){event.preventDefault();console.log(this);accVerify.accept(this)})$('.userId ul li a').on('click',function(event){event.preventDefault();var way=$(this).attr('way');window.open('user.html?userId='+$('.userId').attr('id').substring(4)+'&userTel='+$('.userId').find('a').eq(0).text()+'&way='+way,'_blank')});$('#mask').css('height',$(document.body).height()+'px');$('#mask').click(function(){$('.modall').hide();$('#mask').hide()})});var loginVerify={login:function(){var um=$("#user-mobile").val();var up=$("#user-pwd").val();if(this.check(um,up)){this.LoginSuccess(um,up)}},check:function(um,up){if(um==""){alert("手机号不能为空");$("#user-mobile").focus();return false}if(up==""){alert("密码不能为空")$("#user-pwd").focus();return false}return true},LoginSuccess:function(um,up){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/user/login.do?",data:'user.mobile='+um+'&user.pwd='+up+'',success:function(data){console.log(data.msg);$.cookie(um,up,{path:'/'});var userId=data.data.id;$('.log, #mask').hide();$('nav').find('a.login_btn').remove().end();$('.userId').css('display','block').attr('id','user'+userId).find('a').eq(0).html('<a href="javascript:;"><i class="icon-user"></i>'+um+'</a>')},error:function(){console.log('错误')}})}}var registerVerify={register:function(){if(this.check()){this.RegisterSuccess()}},check:function(){if($("#reg-mobile").val()==""){alert("手机号不能为空");$("#reg-mobile").focus();return false}if($("#reg-pwd").val()==""){alert("密码不能为空")$("#reg-pwd").focus();return false}return true},RegisterSuccess:function(){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/user/register.do?",data:'user.mobile='+$("#reg-mobile").val()+'&user.pwd='+$("#reg-pwd").val()+'&user.userNo='+$("#reg-userNo").val()+'&user.name='+$("#reg-name").val()+'&user.dorm='+$("#reg-dorm").val()+'',success:function(data){console.log(data.msg);$('#mask').addClass('h');if(!parseInt(data.code)){$('.log').show(100);$('.est, .reg').hide()}},error:function(){console.log('错误')}})}}var estVerify={est:function(){if(this.check()){this.EstSuccess()}},check:function(){return true},EstSuccess:function(){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/orderBase/establish.do?",data:$('#orderBaseForm').serialize(),success:function(data){console.log(data.msg);if(!parseInt(data.code)){$('.est, #mask').hide();listVerify.list()}},error:function(){console.log('错误')}})}}var listVerify={list:function(){this.ListSuccess()},ListSuccess:function(){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/orderBase/findByEstablish.do",success:function(data){console.log(data.msg);if(!parseInt(data.code)){var orderBase=data.data;if(orderBase.length){var list_box=$('.properties_list');list_box.html('');for(var i=0;i<orderBase.length;i++){var oLi=$('<li></li>').attr('id','ob'+orderBase[i].id).appendTo(list_box);var oA=$('<a></a>').attr('href','javascript:;').appendTo(oLi);var oImg=$('<img/>').attr('_src','img/property_'+(i%3+1)+'.jpg').appendTo(oA);var oPrice=$('<span></span>').addClass('price').html('RMB '+orderBase[i].price).appendTo(oLi);var oDetail=$('<div></div>').addClass('property_details').appendTo(oLi);var oInfo=$('<div></div>').addClass('list-info').appendTo(oDetail);var oLs=$('<div></div>').addClass('list-status').appendTo(oDetail);var oInc=$('<h1></h1>').addClass('list-inc').appendTo(oInfo);var otTime=$('<h2></h2>').addClass('list-tTime').html('代领时间：').appendTo(oInfo);var osTime=$('<h2></h2>').addClass('list-sTime').html('取货时间：').appendTo(oInfo);var oIncA=$('<a></a>').attr('href','javascript:;').appendTo(oInc);var oSt=$('<span></span>').addClass('property_size').html(orderBase[i].daiTime+':00').appendTo(otTime);var oSs=$('<span></span>').addClass('property_size').html(orderBase[i].sendTime+':00').appendTo(osTime);var oBtn=$('<a class="status-btn"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span></a>').appendTo(oLs);var oStatus=$('<span></span>').addClass('status').appendTo(oBtn);statVerify.stat(orderBase[i].id,orderBase[i].customerId);var inc='';switch(orderBase[i].inc){case 0:inc='韵达快递';break;case 1:inc='圆通快递';break;case 2:inc='申通快递';break;case 3:inc='中通快递';break;case 4:inc='顺丰快递';break;case 5:inc='优速快递';break;default:inc='其他快递';break}oIncA.html(inc)}}$('#mask').css('height',$(document.body).height()+'px')}},error:function(){console.log('错误')}})}}var statVerify={stat:function(id,cId){if(this.check()){this.StatSuccess(id,cId)}},check:function(){return true},StatSuccess:function(id,cId){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/orderProcess/findByOrderId.do?",data:'orderId='+id,success:function(data){console.log(data.msg);console.log(data.data);if(!parseInt(data.code)){console.log('stat success');var stat=data.data.stat;console.log(stat);var btnIn='';switch(stat){case 1:btnIn='接受';break;case 2:btnIn='取消';break;case 3:btnIn='完成';break;case 4:btnIn='已完成';break;case 5:btnIn='已完成';break;case 6:btnIn='已完成';break}$('#ob'+id).find('.status-btn').attr('id','acc'+id).addClass('cId'+cId).find('.status').html(btnIn)}},error:function(){console.log('错误')}})}}var accVerify={accept:function(oBtn){if(this.check(oBtn)){this.AcceptSuccess(oBtn)}},check:function(oBtn){if(!$('.userId').find('a').eq(0).text()){console.log('用户还未登录');$('#mask').show();$('.log').show(100);$('.reg, .est').hide();return false}else{var uId=$('.userId').attr('id').substring(4)}var cId=$(oBtn).attr('class').substring($(oBtn).attr('class').indexOf('cId')+3);if(uId==cId){alert('不能接受自己发布的订单');return false}return true},AcceptSuccess:function(oBtn){$.ajax({type:"GET",url:"http://www.wangchloe.cn:8080/esms/orderBase/updateAgentId.do?",data:'id='+$(oBtn).attr('id').substring(3)+'&agentId='+$('.userId').attr('id').substring(4),success:function(data){console.log(data.msg);$(oBtn).parents('li').remove()},error:function(){console.log('错误')}})}}window.onscroll=function(){var aImg=document.querySelectorAll('.properties_list img');var scrollT=document.documentElement.scrollTop||document.body.scrollTop;var clientH=document.documentElement.clientHeight;var time=0;for(var i=0;i<aImg.length;i++){var oImgT=getPos(aImg[i]).top;if(scrollT+clientH>=oImgT){(function(index){setTimeout(function(){aImg[index].setAttribute('src',aImg[index].getAttribute('_src'))},time)})(i);time+=50}}}function getPos(obj){var l=0;var t=0;while(obj){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}